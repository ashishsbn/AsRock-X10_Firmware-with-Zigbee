<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<META HTTP-EQUIV="Pragma" CONTENT="no-cache" />
<META HTTP-EQUIV="Expires" CONTENT="0" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<script type="text/javascript" src="includes/jquery.min.js"></script>
<script type="text/javascript" src="includes/json2.js"></script>
<script type="text/javascript" src="includes/asrock.js"></script>
<script type="text/javascript" src="includes/idletimer.js"></script>
<script type="text/javascript">writeTitle();</script>
<script type="text/javascript" src="lang/multilanguage.js"></script>
<link rel="stylesheet" type="text/css" href="default.css" />
<script type="text/javascript">

function setData(url) {

  var argu, tableRows, i, cell;
  var secret = $('input#secret').val();
  argu = "&enable=" + parseValueOfOnOff($('#enable').val());
  if(secret.length<6 || secret.length>64) {
    alert(IPSeclWarn2);
    return false;
  }
  if(secret.indexOf("\"")>-1) {
    alert(PopMsg1);
    return false;
  }
  argu += "&secret=" + encodeURIComponent(secret);

  tableRows = document.getElementById("accountList").getElementsByTagName('tr');
  argu += "&totalOfAccounts=" + (tableRows.length - 2);
  
  for (i = 2; i < tableRows.length; i++) {
    cell = tableRows[i].getElementsByTagName('td');
    
    if (!cell.length) {
        continue;
    }
    
    argu += "&username" + padZero(i-2, 3, 1) + "=" + encodeURIComponent(cell[0].innerHTML);
    argu += "&password" + padZero(i-2, 3, 1) + "=" + encodeURIComponent(cell[1].innerHTML);
  }

  console.log("argu " + argu);

  $.ajax({
    url: url,
    type: "POST",
    data: argu,
    dataType: "json",
    success: function(result) {
      //console.log(result);
    },
    error : function() {
      //console.log("post " + url + " error");
    }
  });

  return true;
}

function switchVPNOnOff(switchThis)
{
  if($('#' + switchThis.id).val() == "ON") {
    $('input#secret').removeAttr('disabled');
    $('input[name="ipsecUsername"]').removeAttr('disabled');
    $('input[name="ipsecPassword"]').removeAttr('disabled');
  } else {
    $('input#secret').attr('disabled', 'disabled');
    $('input[name="ipsecUsername"]').attr('disabled', 'disabled');
    $('input[name="ipsecPassword"]').attr('disabled', 'disabled');
  }
}

function addIPSecAccount(username, password)
{
  var tableRows, i, cell;

  // blank username/password
  if(username.length==0) {
    alert(WANWarn5);
    return false;
  } else if(password.length==0) {
    alert(WANWarn4);
    return false;
  }
  
  tableRows = document.getElementById("accountList").getElementsByTagName('tr');
  for (i = 2; i < tableRows.length; i++) {
    cell = tableRows[i].getElementsByTagName('td');
    
    if (!cell.length) {
        continue;
    }
    
    console.log(cell[0].innerHTML+" username: "+username);
    // check conflict username
    if(cell[0].innerHTML==username) {
      alert(IPSeclWarn1);
      return false;
    }
  }
  
  var body, bodyUsername, bodyPassword, bodyDelete;
  bodyUsername = {"align" : "center", "wordBreakAll" : "1", "value" : username};
  bodyPassword = {"align" : "center", "wordBreakAll" : "1", "value" : password};
  bodyDelete = {"classes" : "accountListDel", "isImage" : "1", "imgSrc" : "images/icon-.png"};
  if ((($('#accountListTableBody').children().length) % 2) == 0) {
    bodyUsername["bgcolor"] = "#333333";
    bodyPassword["bgcolor"] = "#333333";
    bodyDelete["bgcolor"] = "#333333";
  }
  body = [bodyUsername, bodyPassword, bodyDelete];      
  $('#accountListTableBody').append(newTableBody(body));
  
  return true;
}

function addUserDefinedAccount()
{
  var username, password;
  var ret;
  
  if($('#enable').val() == "OFF")
    return false;
  
  username = $('input[name="ipsecUsername"]').val();
  password = $('input[name="ipsecPassword"]').val();
  
  ret = addIPSecAccount(username, password);
  if (ret == true) {
    //Empty input fields
    $('input[name="ipsecUsername"]').val("");
    $('input[name="ipsecPassword"]').val("");
  }
  
  return ret;
}

function deleteAccount()
{
  if($('#enable').val() == "OFF")
    return false;
  
  if (!confirm(LANWarn7)) {
    return false;
  }
  else {
    $(this).closest('tr').remove();
  }
}

function refresh_table()
{
  $('#waitingDig').hide();    
  $('#progressBar').hide();
  getvpnstatus();
}

function gotodisconnect(clicked_id){
   var tid_id = clicked_id+"_tid";
   var argu;
 //  var refresh_time = 5000;
 //  var tunnelID ;
   
 //  console.log(clicked_id+tid_id);
   
  // tunnelID = document.getElementById(tid_id).value;
   
   console.log("tid ="+document.getElementById(tid_id).value);
   
    argu = "&tid=" + document.getElementById(tid_id).value;
   
   console.log("argu " + argu);

  $.ajax({
    url: "/f/setl2tpdisconnect",
    type: "POST",
    data: argu,
    dataType: "json",
    success: function(result) {
      console.log(result);
    },
    error : function() {
      console.log("post " + url + " error");
    }
  });
  
   waitTimeout=7;
   showWindow("waitWindow");
   countdownWindow("waitingDig");
  

/*  
  setTimeout(function(){
		  refresh_table();
          },refresh_time);
 */
}

function showstatus(vpnstatus){
   var table_name ;
   
   console.log("num of vpn :" +vpnstatus[0].account_num);
   
   if (parseInt(vpnstatus[0].account_num) > 0) {
      var html, i;
      for(i=1; i<=parseInt(vpnstatus[0].account_num); i++) {
	    var vpn_status_id = "vpnstatus_"+i;

		html = '<tr id="'+ vpn_status_id +'_TableTR">';
        html += '<td align="center" class="style5" id="'+ vpn_status_id +'_TableTD" bgcolor="#333333" width="30%"><h5>' + decodeURIComponent(vpnstatus[i].username) + '</h5></td>';
        if(parseInt(vpnstatus[i].status)>0) {
		  console.log("username :" +vpnstatus[i].username);
		  console.log("ipaddress :" +vpnstatus[i].ipaddress);
		  console.log("device ipaddr :"+vpnstatus[i].deviceIpaddr);
		  console.log("tunnel_id :" +vpnstatus[i].tunnel_id);
		  console.log("status :" + vpnstatus[i].status);
		  html += '<td align="center" class="style5" id="'+ vpn_status_id +'_TableTD" bgcolor="#333333" width="20%"><h5>' + vpnstatus[i].deviceIpaddr + '</h5></td>';
		  html += '<td align="center" class="style5" id="'+ vpn_status_id +'_TableTD" bgcolor="#333333" width="20%"><h5>' + vpnstatus[i].ipaddress + '</h5></td>';
		  html += '<td align="center" class="style5" id="'+ vpn_status_id +'_TableTD" bgcolor="#333333" width="20%"><h5>' + DashConnected + '</h5></td>';
//		  html += '<td align="center" class="style5" id="'+ vpn_status_id +'_TableTD" bgcolor="#333333" width="20%"><h5><input name="input" id="'+ vpn_status_id +'" type="button" value="'+DashConnected+'" onclick="gotodisconnect(this.id);"></h5></td>';
           html += '<td align="center" class="style5" id="'+ vpn_status_id +'_TableTD" bgcolor="#333333" width="10%"><h5><img src="images/icon-.png" width="18" height="18" id="'+ vpn_status_id +'" onclick="gotodisconnect(this.id);"></h5></td>';
		  html += '<td style="display:none;" id="'+ vpn_status_id +'_TableTD"><h5><input type="hidden" id="'+ vpn_status_id +'_tid" value ='+vpnstatus[i].tunnel_id+'></h5></td>';
        }else{
		   html += '<td align="center" class="style5" id="'+ vpn_status_id +'_TableTD" bgcolor="#333333" width="20%"><h5></h5></td>';
		   html += '<td align="center" class="style5" id="'+ vpn_status_id +'_TableTD" bgcolor="#333333" width="20%"><h5></h5></td>';
		   html += '<td align="center" class="style5" id="'+ vpn_status_id +'_TableTD" bgcolor="#333333" width="20%"><h5>'+DashDisconnected+'</h5></td>';
		   html += '<td align="center" class="style5" id="'+ vpn_status_id +'_TableTD" bgcolor="#333333" width="10%"><h5></h5></td>';
		}
//		html += '<td width="5%"align="center" bgcolor="#333333"><h5></h5></td>'
		html += '<tr>';
        $('#vpnstatusTable').append(html);
      }
   }
}

function changePskStat(maskChecked)
{
  changePassStat("secret", maskChecked);
}
function getvpnstatus(){
   var account_number;
   var vpnstatus;
   
   
   vpnstatus = getData("/f/getIpsecStatus");
   if (vpnstatus != null) {
   
   var tb = document.getElementById('vpnstatusTable');
   
   while(tb.rows.length > 1) {
      tb.deleteRow(1);
   }
  
   
 //    console.log("num of vpn :" +vpnstatus[0].account_num);
/*	 
   if(nVPNstatus != 0){
     for(i=1;i<=nVPNstatus;i++){
       var vpn_status_id = "vpnstatus_"+i;
       $('#vpnstatusTable tr#' + vpn_status_id + '_TableTR').remove();
     }
   }
   nVPNstatus = parseInt(vpnstatus[0].account_num);
 */   
   showstatus(vpnstatus);
 
   }
}


$(document).ready(function() {
  //console.log("document ready!!!");
  isLoggedIn();

  /* Setup the Menu, expand the VPN items */
  $('#vpnMenu').parent().removeClass('menu');
  $('#vpnMenu').parent().addClass('mainmenu');
  $('#vpnMenu').find('.submenu').addClass('show_menu');
  $('.show_menu').show();
  $('#vpnIpsec').removeClass('show_menu');
  $('#vpnIpsec').removeClass('submenu');
  $('#vpnIpsec').addClass('mainsubmenu');
  $('#vpnIpsec').addClass('show_menu');

  /* Empty category arrays */
  emptyElementArrays();

  /* */
  text(IPSecSecret, "secret", null, 1);
  $('input#secret').attr('maxlength', 64);
  $('input#secret').after("&nbsp;<input type=\"checkbox\" id=\"passwordMask\" checked onclick=\"changePskStat(this.checked);\"><span>" + WirelessMask + "</span></input>");

  label(WANAccount, "account");
 // button(" ","vpnstatus",USBStatus, getvpnstatus);

  var id, head, body;
  id = "accountList";
  head = [{"desc" : WANUserName, "width" : "40%", "align" : "center"},
          {"desc" : WANPassword, "width" : "40%", "align" : "center"},
          {"desc" : WANAddDelete, "width" : "20%", "align" : "center"}];
  body = [{"align" : "center", "bgcolor" : "#333333", "isInput" : "1", "inputWidth" : "80%", "maxSize": "32", "name" : "ipsecUsername"},
          {"align" : "center", "bgcolor" : "#333333", "isInput" : "1", "inputWidth" : "90%", "maxSize": "15", "name" : "ipsecPassword"},
          {"id" : id + "Add", "bgcolor" : "#333333", "isImage" : "1", "imgSrc" : "images/icon+.png"}];
  tableList(id, head, body, "75%");
  
  $('#' + id + 'Add').click(addUserDefinedAccount);
  $('#' + id + 'TableBody').on("click", '.' + id + 'Del', deleteAccount);
  
  nVPNstatus = 0;

  /* Get the data and fill the DOM */
  var ipsecInfo = getData("/f/getIpsecInfo");
  var wanL2TP = 0;

  if (ipsecInfo != null) {
    var accountInfo = ipsecInfo.accounts;
    for (i = 0; i < ipsecInfo.total; i++) {
      addIPSecAccount(decodeURIComponent(accountInfo[i].username), 
                      decodeURIComponent(accountInfo[i].password));
    }

    if(ipsecInfo.proto=="l2tp") {
      wanL2TP = 1;
    } else {
      switchOnOff(OpenvpnServerEnable, "enable", switchVPNOnOff);
    }

    /* Put the value into the DOM by key (id) */
    $.each(ipsecInfo, function(key, value) {
      console.log("key : " + key + " value : " + value);
      doAssignValues(key, decodeURIComponent(value));
    });

  }
  
  getvpnstatus();

  if(wanL2TP==1) {
    switchOnOffDisable(OpenvpnServerEnable, "enable");
  } else {
    /* Apply action */
    $('[id=Apply]').click(function(event) {
      //console.log("apply click...");
      if (setData("/f/setIpsecInfo")) {
        waitTimeout=15;
        showWindow("waitWindow");
        countdownWindow("waitingDig");
      }
    });
  }

  // initialize the status of text fields
  if($('#enable').val() == "OFF") {
    $('input#secret').attr('disabled', 'disabled');
    $('input[name="ipsecUsername"]').attr('disabled', 'disabled');
    $('input[name="ipsecPassword"]').attr('disabled', 'disabled');
  }

  /* Cancel action */
  $("[id=Cancel]").click(function(event) {
    //console.log("cancel click...");
    refresh();
  });
});
</script>
</head>
<body onload="preloadX10Images()">
<div style="width:960px;margin:0px auto;">
  <table width="100%" border="0" cellspacing="0" cellpadding="0">
    <tr>
      <td><table width="100%" border="0" cellspacing="0" cellpadding="0">
        <tr>
          <td height="20" valign="top">&nbsp;</td>
        </tr>
        <script type="text/javascript">writeHeader();</script>
        <tr>
          <td align="left" background="images/UI-new_10.png"><table width="100%" border="0" cellpadding="0" cellspacing="0">
            <tr>
              <td>&nbsp;</td>
              <td width="168">&nbsp;</td>
              <td>&nbsp;</td>
              <td width="736" align="center" valign="top">&nbsp;</td>
            </tr>
            <tr>
              <td width="20">&nbsp;</td>
              <td valign="top"><table border="0" cellspacing="0" cellpadding="0">
                <script type="text/javascript">writeLeftMenu();</script> 
              </table></td>
              <td width="15">&nbsp;</td>
              <td align="center" valign="top"><table width="98%" border="0" cellspacing="2" cellpadding="2">
                <form id="openvpnform" name="openvpnform">
                  <tr>
                    <td colspan="2" align="left"><h4><script>document.write(VPNIPSec);</script></h4></td>
                  </tr>
                  <tr>
                    <td colspan="2" align="left" class="style8"><img src="images/line-s.png" width="470" height="5" /></td>
                  </tr>
                  <tr id="enable">
                  </tr>
                  <tr id="secret">
                  </tr>
                  <tr id="account">
                  </tr>
                  <tr id="accountList">
                  </tr>
                  <tr><td>&nbsp;</td></tr>
                  <tr><td>&nbsp;</td></tr>
                  <tr>
                    <td colspan="2" align="left"><h4><script>document.write(IPv6AutoStatus);</script></h4></td> 
				  </tr> 
				  <tr>
                    <td class="middlespace">&nbsp;</td>
                      <td width="50%" align="right" valign="bottom">
                         <span class="style8">
                            <a href="#" onclick="getvpnstatus();"><span ><script>document.write(GeneralRefreshStatus);</script></span></a>
                         </span>
                    </td>
                  </tr>
				  <tr><td colspan="3" align=right>
                        <table width="100%" border="0" cellpadding="3" cellspacing="1" class="pixeltable" id="vpnstatusTable">
                           <tr>
						      <td width="30%"align="center" bgcolor="#666666"><h5 ><script>document.write(WANUserName);</script></h5></td>
							  <td width="20%"align="center" bgcolor="#666666"><h5><span><script>document.write(DashDevice);</script></span></h5></td>
                              <td width="20%"align="center" bgcolor="#666666"><h5><span><script>document.write(AdvIPAddress);</script></span></h5></td>
                              <td width="20%"align="center" bgcolor="#666666"><h5 ><script>document.write(IPv6AutoStatus);</script></h5></td>
                              <td width="10%"align="center" bgcolor="#666666"><h5><script>document.write(DashDisconnected);</script></h5></td>
                           </tr>
                        </table>
                  </td></tr>
                  <script type="text/javascript">writeApplyCancel();</script>
                </form>
              </table></td>
            </tr>
          </table></td>
        </tr>
        <tr>
          <td><img src="images/UI-new_11.png" width="960" height="8" /></td>
        </tr>
      </table></td>
    </tr>
  </table>
  <script type="text/javascript">writeFooter();</script>
</div>
<!-- End Save for Web Slices -->
<script type="text/javascript">
  writeWindow("cover");
  writeWindow("waitWindow");
</script>
</body>
</html>
